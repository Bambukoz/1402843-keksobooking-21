(()=>{"use strict";(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success"),o=()=>{document.location.reload()};window.statusMessage={onError:t=>{const r=e.cloneNode(!0);t?(r.querySelector(".error__message").textContent=t,r.querySelector(".error__button").textContent="Перезагрузить страницу",r.querySelector(".error__button").addEventListener("click",o)):r.querySelector(".error__button").addEventListener("click",window.util.onCloseBtnClick),r.addEventListener("click",window.util.onMouseClick),document.addEventListener("keydown",window.util.onEscBtnClick),document.querySelector("main").prepend(r)},onLoad:()=>{const e=t.cloneNode(!0);e.addEventListener("click",window.util.onMouseClick),document.addEventListener("keydown",window.util.onEscBtnClick),document.querySelector("main").prepend(e),window.main.resetPage()}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o="GET",r="POST",n=(t,r,n,a,c=null)=>{const i=new XMLHttpRequest;i.timeout=1e4,t===o&&(i.responseType="json"),i.addEventListener("load",(()=>((t,o,r)=>{switch(t.status){case 200:t.responseURL===e?o(t.response):o();break;case 404:r("При загрузке данных с сервера произошла ошибка!");break;case 500:case 400:r()}})(i,r,n))),i.addEventListener("error",(()=>n("Проблемы с соединением. Попробуйте перезагрузить страницу"))),i.addEventListener("timeout",(()=>n("Время ожидания ответа от сервера превысило 10 секунд. Попробуйте перезагрузить страницу"))),i.open(t,a),i.send(c)};window.backend={load:(t,r)=>{n(o,t,r,e)},save:(e,o,a)=>{n(r,o,a,t,e)}}})(),(()=>{let e=null;window.debounce={setDebounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e="any",t="low",o=1e4,r="middle",n="high",a=5e4,c=document.querySelector(".map__filters"),i=c.querySelector("#housing-type"),s=c.querySelector("#housing-price"),d=c.querySelector("#housing-rooms"),u=c.querySelector("#housing-guests"),l=c.querySelector(".map__features"),p=c=>{return f=c.offer.type,(i.value===e||f===i.value)&&(e=>{switch(s.value){case t:return e<o;case r:return e>=o&&e<=a;case n:return e>a}return e})(c.offer.price)&&(w=c.offer.rooms,d.value===e||w.toString()===d.value)&&(m=c.offer.guests,u.value===e||m.toString()===u.value)&&(p=c.offer.features,Array.from(l.querySelectorAll("input[type=checkbox]:checked")).map((e=>e.value)).every((e=>p.includes(e))));var p,m,w,f},m=()=>{window.card.removeCard();const e=window.pinsList.filter(p);window.pin.createPins(e.slice(0,5))},w=()=>{window.debounce.setDebounce(m)},f=e=>{Array.from(c.children).forEach((t=>{t.disabled=e})),e?(c.removeEventListener("change",w),c.reset()):c.addEventListener("change",w)};f(!0),window.filter={filteredPins:m,inactivateFilter:f}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector(".ad-form-header__preview img"),o=e.querySelector(".ad-form__photo"),r={PNG:"image/png",JPG:"image/jpg",JPEG:"image/jpeg"},n="70px",a="70px",c="5px",i="cover",s="-15px",d=(e,t=!1)=>{e.style.width=n,e.style.height=a,e.style.borderRadius=c,e.style.objectFit=i,t&&(e.style.marginLeft=s)},u=e=>{o.textContent="";const t=document.createElement("img");t.src=e.target.result,d(t),o.append(t),e.target.removeEventListener("load",u)},l=e=>{t.src=e.target.result,d(t,!0),e.target.removeEventListener("load",l)};window.photos={setImage:t=>{const o=t.target.files[0];[r.PNG,r.JPG,r.JPEG].includes(o.type)&&((t,o)=>{const r=new FileReader;t.target===e.avatar?r.addEventListener("load",l):r.addEventListener("load",u),r.readAsDataURL(o)})(t,o)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector(".ad-form-header__preview img"),o=e.querySelector(".ad-form__photo"),r=e.querySelector(".ad-form__reset"),n=e.querySelectorAll("fieldset"),a={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},c={bungalow:0,flat:1e3,house:5e3,palace:1e4},i="img/muffin-grey.svg",s=40,d=44,u=t=>{switch(t.target){case e.type:e.price.min=c[e.type.value],e.price.placeholder=c[e.type.value];break;case e.rooms:case e.capacity:(()=>{const t=a[e.rooms.value].includes(e.capacity.value)?"":"Несоответствие количества комнат количеству гостей";e.capacity.setCustomValidity(t),e.capacity.reportValidity()})();break;case e.timein:case e.timeout:(t=>{t.target===e.timein?e.timeout.value=e.timein.value:e.timein.value=e.timeout.value})(t);break;case e.avatar:case e.images:window.photos.setImage(t)}},l=t=>{t.preventDefault(),window.backend.save(new FormData(e),window.statusMessage.onLoad,window.statusMessage.onError)},p=e=>{e.target===r&&window.main.resetPage()},m=t=>{Array.from(n).forEach((e=>{e.disabled=t})),t?(e.removeEventListener("change",u),e.removeEventListener("submit",l),e.removeEventListener("click",p)):(e.addEventListener("change",u),e.addEventListener("submit",l),e.addEventListener("click",p))};m(!0),window.form={resetForm:()=>{t.style="",t.src=i,t.width=s,t.height=d,o.textContent="",e.price.min=c.flat,e.price.placeholder=c.flat,e.reset()},inactivateForm:m}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.style.left=e.location.x+"px",o.style.top=e.location.y+"px",o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={createPins:t=>{const r=document.createDocumentFragment();for(let e of t){const t=o(e);r.append(t),t.addEventListener("click",(()=>{window.card.createCard(e)}))}window.main.resetMap(),e.append(r)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o={WIDTH:62,HEIGHT:84},r=0-o.WIDTH/2,n=e.offsetWidth-o.WIDTH/2;t.addEventListener("mousedown",(e=>{e.preventDefault();let o={X:e.clientX,Y:e.clientY};const a=e=>{e.preventDefault();const a=o.X-e.clientX,c=o.Y-e.clientY,i=t.offsetLeft-a,s=t.offsetTop-c;o={X:e.clientX,Y:e.clientY},i>=r&&i<=n&&(t.style.left=i+"px"),s>=130&&s<=630&&(t.style.top=s+"px"),window.main.setMainAddress()},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)})),window.dragAndDrop={PinSize:o}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=e.querySelector(".map__pin--main"),r="375px",n="570px",a=e=>{window.pinsList=e,window.filter.inactivateFilter(!1),window.filter.filteredPins()},c=()=>{e.classList.remove("map--faded"),window.backend.load(a,window.statusMessage.onError,!0),i()},i=()=>{t.classList.remove("ad-form--disabled"),window.form.inactivateForm(!1),o.removeEventListener("click",c)},s=()=>{const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(let e of t)e.remove();window.card.removeCard()},d=()=>{t.address.value=`${parseInt(o.style.left,10)+window.dragAndDrop.PinSize.WIDTH/2}, ${parseInt(o.style.top,10)+window.dragAndDrop.PinSize.HEIGHT}`};d(),o.addEventListener("click",c),window.main={setMainAddress:d,resetMap:s,resetPage:()=>{s(),window.form.resetForm(),window.form.inactivateForm(!0),window.filter.inactivateFilter(!0),e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),o.style.left=n,o.style.top=r,o.addEventListener("click",c),d()}}})(),(()=>{const e=document.querySelector(".map"),t={wifi:"popup__feature--wifi",dishwasher:"popup__feature--dishwasher",parking:"popup__feature--parking",washer:"popup__feature--washer",elevator:"popup__feature--elevator",conditioner:"popup__feature--conditioner"},o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=document.querySelector("#card").content.querySelector(".popup"),n=document.querySelector("#photo").content,a=e=>{const o=document.createElement("li");return o.className="popup__feature "+t[e],o},c=e=>{const t=n.cloneNode(!0);return t.querySelector("img").src=e,t},i=()=>{const t=e.querySelector(".popup");e.contains(t)&&t.remove()};window.card={removeCard:i,createCard:t=>{i(),e.append((e=>{const t=r.cloneNode(!0),n=t.querySelector(".popup__features"),i=t.querySelector(".popup__photos");document.addEventListener("keydown",window.util.onEscBtnClick),t.querySelector(".popup__close").addEventListener("click",window.util.onCloseBtnClick),t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+" ₽/ночь",t.querySelector(".popup__type").textContent=o[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${window.util.getWordsEndings(e.offer.rooms,["комната","комнаты","комнат"])} для ${e.offer.guests} ${window.util.getWordsEndings(e.offer.guests,["гостя","гостей","гостей"])}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;for(let t of e.offer.features)n.append(a(t));for(let t of e.offer.photos)i.append(c(t));return t.querySelector(".popup__description").textContent=e.offer.description,t})(t))}}})(),(()=>{const e=t=>{const o=document.querySelector(".error"),r=document.querySelector(".success"),n=document.querySelector(".popup");"Escape"===t.key&&(t.preventDefault(),o&&o.remove(),r&&r.remove(),n&&n.remove(),document.removeEventListener("keydown",e))},t=o=>{o.target.parentElement.remove(),o.target.removeEventListener("click",t),document.removeEventListener("keydown",e)};window.util={getWordsEndings:(e,t)=>t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]],onEscBtnClick:e,onMouseClick:()=>{document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("keydown",e)},onCloseBtnClick:t}})()})();